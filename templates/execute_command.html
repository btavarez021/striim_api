<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<title>Execute Command on Linux Box</title>
<style>
       .spinner-border {
           display: none;
           margin-left: 10px;
       }
       #logs {
           background-color: #f8f9fa;
           font-family: monospace;
           height: 200px;
           width: 100%;
           overflow-y: auto;
       }

</style>
</head>
<body>
   {% include 'static/navbar.html' %}
<div class="container mt-5">
<h2 class="text-center">Execute Command on Linux Box</h2>
<form id="command-form" class="mt-4">
<div class="mb-4">
<label for="shipDropdown" class="form-label">Select Ships (Hold Ctrl or Cmd to select multiple):</label>
               {% include 'static/dropdown_selection.html' %}
</div>
<div class="mb-3">
<label for="command" class="form-label">Input Commands:</label>
<textarea class="form-control" id="send-command-to-ship" rows="3" required></textarea>
</div>
<button id="send-command" class="btn btn-primary" type="submit">Send Command
<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
</button>
</form>
<div class="mt-5">
<h2>Logs</h2>
<textarea id="logs" class="form-control" rows="10" readonly></textarea>
</div>
</div>

<script>
       const form = document.getElementById('command-form');
const logs = document.getElementById('logs');
const sendButton = document.getElementById('send-command');
const spinner = sendButton.querySelector('.spinner-border');
// Assuming the ship names have already been fetched and stored in allShips
let allShips = [];
// Fetch ship names from JSON file
fetch('http://localhost:5000/load_ships') // Update this path based on your project structure
   .then(response => response.json())
   .then(data => {
       allShips = data.ships; // Store ship names in the allShips variable
   })
   .catch(error => {
       console.error("Error fetching ship names:", error);
   });
form.addEventListener('submit', function (e) {
   e.preventDefault();
   spinner.style.display = 'inline-block';
   sendButton.disabled = true; // Disable button during execution
   const selectedOptions = Array.from(document.getElementById('shipDropdown').selectedOptions);
   const selectedHosts = selectedOptions.map(option => option.value);
   // Check if 'All Ships' is selected
   if (selectedHosts.includes('All')) {
       selectedHosts.length = 0; // Clear the current array
       selectedHosts.push(...allShips); // Add all ships to the selected hosts
   }
   const command = document.getElementById('send-command-to-ship').value;
   console.log(`Sending command: ${command} to hosts: ${selectedHosts}`);
   // Send the command to the selected hosts
   const payload = { hosts: selectedHosts, command: command };
   console.log("PAYLOAD: ", payload);
   fetch('http://localhost:5000/execute-command', {
       method: 'POST',
       headers: {
           'Content-Type': 'application/json',
       },
       body: JSON.stringify(payload),
   })
   .then(response => response.json())
   .then(data => {
   console.log("Received response from backend:", data);
   // Loop through the results and append them to the logs
   if (data.results) {
       data.results.forEach((result, index) => {
            const shipName= selectedHosts[index];
           // Displaying the output or error based on the execution result
           if (result.error.length > 0) {
               logs.value += `Error on ${shipName}: \n${result.error.join(', ')}\n`;
           } else {
               logs.value += `Output from ${shipName}: \n ${result.output.join('\n')}\n`;
           }
       });
   } else {
       logs.value += `Output: ${data.message}\n`; // Fallback if the response doesn't match expected format
   }
   logs.scrollTop = logs.scrollHeight; // Scroll to the bottom of the logs
})
   .catch(error => {
       console.error("Error:", error);
       logs.value += `Error: ${error.message}\n`;
       logs.scrollTop = logs.scrollHeight;
   })
   .finally(() => {
       spinner.style.display = 'none'; // Hide spinner
       sendButton.disabled = false; // Re-enable button
   });
});
</script>
</body>
</html>